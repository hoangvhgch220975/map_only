<!DOCTYPE html>
<html>
<head>
  <title>Map Route from Current Location</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }
  </style>
</head>
<body>

<div id="map"></div>

<!-- Load Leaflet and Routing libraries -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.min.js"></script>

<script>
  const map = L.map('map').setView([16.0471, 108.2062], 6); // Vi·ªát Nam trung t√¢m

  // Add base layer
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // L·∫•y query t·ª´ URL ?q=
  const params = new URLSearchParams(window.location.search);
  const searchQuery = params.get('q'); // ƒë·ªãa ƒëi·ªÉm c·∫ßn t√¨m

  let currentLatLng = null;

  // B1: L·∫•y v·ªã tr√≠ hi·ªán t·∫°i
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      currentLatLng = L.latLng(pos.coords.latitude, pos.coords.longitude);
      L.marker(currentLatLng).addTo(map).bindPopup("üìç You are here").openPopup();
      map.setView(currentLatLng, 14);

      if (searchQuery) {
        // B2: T√¨m ƒëi·ªÉm ƒë·∫øn t·ª´ query
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}`)
          .then(res => res.json())
          .then(data => {
            if (data.length > 0) {
              const destLatLng = L.latLng(data[0].lat, data[0].lon);
              L.marker(destLatLng).addTo(map).bindPopup("üìå " + searchQuery).openPopup();

              // B3: Hi·ªÉn th·ªã ƒë∆∞·ªùng ƒëi v·ªõi m√†u xanh d∆∞∆°ng
              const routeControl = L.Routing.control({
                waypoints: [currentLatLng, destLatLng],
                routeWhileDragging: false,
                fitSelectedRoutes: true, // ‚úÖ T·ª± zoom ƒë·ªÉ th·∫•y to√†n tuy·∫øn
                showAlternatives: false,
                createMarker: function(i, wp, nWps) {
                  return L.marker(wp.latLng).bindPopup(i === 0 ? "üìç Start" : "üèÅ Destination");
                },
                lineOptions: {
                  styles: [{ color: 'blue', opacity: 0.7, weight: 5 }] // ƒê∆∞·ªùng m√†u xanh d∆∞∆°ng
                }
              }).addTo(map);
            } else {
              alert("‚ùå Location not found.");
            }
          });
      }
    }, err => {
      alert("‚ö†Ô∏è Cannot access your location: " + err.message);
    });
  } else {
    alert("‚ùå Your browser does not support Geolocation.");
  }
</script>

</body>
</html>
