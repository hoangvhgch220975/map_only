<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Mobile Map Picker</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    * {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      position: fixed;
      width: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }

    #map {
      height: 100%;
      width: 100%;
      position: absolute;
      top: 0;
      left: 0;
    }

    /* Search Bar - Mobile optimized */
    #searchBar {
      position: absolute;
      top: 10px;
      left: 10px;
      right: 80px;
      z-index: 2000;
      display: flex;
      align-items: center;
      background: white;
      border-radius: 28px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.3);
      padding: 4px;
    }

    #searchBox {
      flex: 1;
      border: none;
      outline: none;
      font-size: 15px;
      padding: 10px 16px;
      background: transparent;
      min-width: 0;
    }

    #searchIcon {
      border: none;
      background: #2C5E1A;
      color: white;
      cursor: pointer;
      padding: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      border-radius: 24px;
      width: 48px;
      height: 48px;
      flex-shrink: 0;
    }

    #searchIcon:active {
      transform: scale(0.95);
    }

    /* Info Panel - Bottom positioned for mobile */
    #infoPanel {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 16px;
      box-shadow: 0 -2px 20px rgba(0,0,0,0.2);
      z-index: 2000;
      transform: translateY(100%);
      transition: transform 0.3s ease;
      max-height: 40vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    #infoPanel.show {
      transform: translateY(0);
    }

    #infoPanel strong {
      color: #2C5E1A;
      font-size: 16px;
      display: block;
      margin-bottom: 8px;
    }

    #infoPanel .info-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }

    #infoPanel .info-row:last-child {
      border-bottom: none;
    }

    #infoPanel .info-label {
      color: #666;
      font-weight: 500;
    }

    #infoPanel .info-value {
      color: #333;
      font-weight: 600;
      text-align: right;
      flex: 1;
      margin-left: 12px;
      word-break: break-word;
    }

    /* Confirm Button */
    #confirmButton {
      width: 100%;
      padding: 16px;
      background: #2C5E1A;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      margin-top: 12px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(44,94,26,0.3);
    }

    #confirmButton:active {
      transform: scale(0.98);
    }

    /* Search Results - Mobile optimized */
    #searchResults {
      position: absolute;
      top: 70px;
      left: 10px;
      right: 10px;
      background: white;
      border-radius: 16px;
      z-index: 2001;
      box-shadow: 0 4px 20px rgba(0,0,0,0.25);
      display: none;
      max-height: 60vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .result-item {
      padding: 16px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      font-size: 14px;
      line-height: 1.4;
    }

    .result-item:last-child {
      border-bottom: none;
    }

    .result-item:active {
      background: #f5f5f5;
    }

    /* Current Location Button */
    .location-button {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1500;
      background: white;
      border: none;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      cursor: pointer;
      font-size: 24px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #2C5E1A;
    }

    .location-button:active {
      transform: scale(0.95);
    }

    .location-button.loading {
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    /* Directions Toggle (hidden initially) */
    #toggleDirections {
      position: absolute;
      bottom: 16px;
      left: 16px;
      z-index: 1500;
      background: white;
      border: none;
      border-radius: 12px;
      padding: 12px 20px;
      cursor: pointer;
      font-size: 13px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.3);
      color: #2C5E1A;
      font-weight: 600;
      display: none;
    }

    #toggleDirections.show {
      display: block;
    }

    .leaflet-routing-container {
      display: none !important;
    }

    /* Loading overlay */
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.9);
      z-index: 3000;
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }

    .loading-overlay.show {
      display: flex;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #2C5E1A;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      color: #2C5E1A;
      font-size: 16px;
      font-weight: 600;
    }

    /* Custom marker popup */
    .leaflet-popup-content-wrapper {
      border-radius: 12px;
      padding: 4px;
    }

    .leaflet-popup-content {
      margin: 12px;
      font-size: 14px;
      line-height: 1.4;
    }
  </style>
</head>

<body>

<!-- Search bar - Thanh t√¨m ki·∫øm -->
<div id="searchBar">
  <input id="searchBox" type="text" placeholder="Search location..." autocomplete="off">
  <button id="searchIcon">
    <i class="fa fa-search"></i>
  </button>
</div>

<!-- Current location button - N√∫t v·ªã tr√≠ hi·ªán t·∫°i -->
<button class="location-button" id="currentLocationBtn" title="Current Location">
  <i class="fa fa-location-crosshairs"></i>
</button>

<div id="searchResults"></div>

<!-- Info panel - Panel th√¥ng tin ƒë·ªãa ƒëi·ªÉm -->
<div id="infoPanel">
  <strong>üìç Picked Location</strong>
  <div class="info-row">
    <span class="info-label">Name:</span>
    <span class="info-value" id="locationName">Not selected</span>
  </div>
  <div class="info-row">
    <span class="info-label">Distance:</span>
    <span class="info-value" id="distanceValue">0 km</span>
  </div>
  <div class="info-row">
    <span class="info-label">Coordinates:</span>
    <span class="info-value" id="coordValue">-</span>
  </div>
  <button id="confirmButton">
    <i class="fa fa-check"></i> Confirm Location
  </button>
</div>

<!-- Toggle directions button - N√∫t xem ch·ªâ ƒë∆∞·ªùng -->
<button id="toggleDirections">
  <i class="fa fa-route"></i> Show Directions
</button>

<!-- Loading overlay - M√†n h√¨nh loading -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-text">Calculating...</div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>

<script>
  // Default start location (Hanoi)
  let startLatLng = L.latLng(21.028511, 105.804817);
  let isGettingCurrentLocation = false;

  const map = L.map('map', {
    center: startLatLng,
    zoom: 14,
    zoomControl: true,
    attributionControl: false
  });

  // Move zoom control to bottom right
  map.zoomControl.setPosition('bottomright');

  // Base layer
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
  }).addTo(map);

  // Start marker - green - Marker xu·∫•t ph√°t m√†u xanh l√°
  let startMarker = L.marker(startLatLng, {
    icon: L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    })
  }).addTo(map).bindPopup('üìç Start Point');

  let routingControl = null;
  let destMarker = null;
  let currentDistance = 0;
  let selectedLocation = null;

  // Get current location from device - L·∫•y v·ªã tr√≠ hi·ªán t·∫°i t·ª´ thi·∫øt b·ªã
  function getCurrentLocation() {
    // Prevent multiple simultaneous requests - NgƒÉn g·ªçi nhi·ªÅu l·∫ßn c√πng l√∫c
    if (isGettingCurrentLocation) return;

    const btn = document.getElementById('currentLocationBtn');
    btn.classList.add('loading');
    isGettingCurrentLocation = true;

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          // Success callback - Callback th√†nh c√¥ng
          startLatLng = L.latLng(position.coords.latitude, position.coords.longitude);
          startMarker.setLatLng(startLatLng);
          map.setView(startLatLng, 15);
          startMarker.bindPopup('üìç Your Current Location').openPopup();

          btn.classList.remove('loading');
          isGettingCurrentLocation = false;

          console.log('‚úÖ Got current location:', startLatLng);
        },
        (error) => {
          // Error callback - Callback l·ªói
          console.warn('‚ùå Geolocation error:', error);
          alert('Cannot get current location. Please enable GPS and grant location permission.');
          btn.classList.remove('loading');
          isGettingCurrentLocation = false;
        },
        {
          enableHighAccuracy: true, // ƒê·ªô ch√≠nh x√°c cao
          timeout: 10000, // Timeout 10 gi√¢y
          maximumAge: 0 // Kh√¥ng d√πng cache
        }
      );
    } else {
      alert('Browser does not support GPS');
      btn.classList.remove('loading');
      isGettingCurrentLocation = false;
    }
  }

  // Try to get current location on load - T·ª± ƒë·ªông l·∫•y v·ªã tr√≠ khi load
  setTimeout(getCurrentLocation, 1000);

  // Current location button
  document.getElementById('currentLocationBtn').onclick = getCurrentLocation;

  function updateInfoPanel(latlng, name) {
    selectedLocation = { lat: latlng.lat, lon: latlng.lng, name: name };

    document.getElementById('locationName').textContent = name || 'Unknown';
    document.getElementById('coordValue').textContent = `${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;

    // Show info panel
    document.getElementById('infoPanel').classList.add('show');
  }

  function updateDistance(distanceKm) {
    currentDistance = distanceKm;
    document.getElementById('distanceValue').textContent = distanceKm + ' km';
  }

  function showLoading(show) {
    const overlay = document.getElementById('loadingOverlay');
    if (show) {
      overlay.classList.add('show');
    } else {
      overlay.classList.remove('show');
    }
  }

  function drawRoute(destLatLng) {
    showLoading(true);

    if (routingControl) map.removeControl(routingControl);
    if (destMarker) map.removeLayer(destMarker);

    // Destination marker - red - Marker ƒë√≠ch m√†u ƒë·ªè
    destMarker = L.marker(destLatLng, {
      icon: L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      })
    }).addTo(map).bindPopup('üéØ Destination');

    updateDistance('0');

    // Create routing control - T·∫°o route t·ª´ start ƒë·∫øn destination
    routingControl = L.Routing.control({
      waypoints: [startLatLng, destLatLng], // ƒêi·ªÉm ƒë·∫ßu v√† ƒëi·ªÉm cu·ªëi
      routeWhileDragging: false, // Kh√¥ng t√≠nh l·∫°i khi k√©o
      addWaypoints: false, // Kh√¥ng cho th√™m waypoint
      fitSelectedRoutes: true, // T·ª± ƒë·ªông zoom v√†o route
      show: false, // ·∫®n panel ch·ªâ ƒë∆∞·ªùng
      lineOptions: {
        styles: [{ color: '#2C5E1A', weight: 5, opacity: 0.8 }] // M√†u xanh l√° M-Hike
      }
    }).addTo(map);

    routingControl.on("routesfound", function(e) {
      const route = e.routes[0];
      if (route && route.summary) {
        const distanceKm = (route.summary.totalDistance / 1000).toFixed(2);
        updateDistance(distanceKm);
        showLoading(false);

        // Show directions button
        document.getElementById('toggleDirections').classList.add('show');
      }
    });

    routingControl.on("routingerror", function(e) {
      console.error('Routing error:', e);
      showLoading(false);
      updateDistance('N/A');
    });
  }

  // Reverse geocoding
  async function getLocationName(latlng) {
    try {
      const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${latlng.lat}&lon=${latlng.lng}`;
      const res = await fetch(url, {
        headers: { 'User-Agent': 'MHikeApp/1.0' }
      });
      if (!res.ok) throw new Error('Network error');
      const data = await res.json();
      return data.display_name || 'Unknown Location';
    } catch (err) {
      console.error(err);
      return 'Unknown Location';
    }
  }

  // Send result to Flutter
  function notifyFlutter(latlng, name, distance) {
    try {
      if (window.MapPickerChannel && window.MapPickerChannel.postMessage) {
        const payload = {
          lat: latlng.lat,
          lon: latlng.lng,
          name: name || document.getElementById('locationName')?.textContent || 'Unknown Location',
          distance: parseFloat(distance) || 0
        };
        console.log('üì§ Sending to Flutter:', payload);
        window.MapPickerChannel.postMessage(JSON.stringify(payload));
      } else {
        console.log('‚ö†Ô∏è MapPickerChannel not available (browser mode)');
        console.log('Would send:', { lat: latlng.lat, lon: latlng.lng, name: name, distance: distance });
      }
    } catch (e) {
      console.error('‚ùå notifyFlutter error:', e);
    }
  }

  // SEARCH
  const searchBox = document.getElementById('searchBox');
  const searchResults = document.getElementById('searchResults');
  const searchIcon = document.getElementById('searchIcon');

  searchIcon.onclick = search;
  searchBox.onkeydown = (e) => { if (e.key === 'Enter') search(); };

  async function search() {
    const text = searchBox.value.trim();
    if (text.length < 2) return;

    showLoading(true);
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(text)}`;

    try {
      const res = await fetch(url, {
        headers: { 'User-Agent': 'MHikeApp/1.0' }
      });
      const data = await res.json();
      showLoading(false);

      searchResults.innerHTML = '';
      // No results found - Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£
      if (data.length === 0) {
        searchResults.innerHTML = '<div class="result-item">No results found</div>';
        searchResults.style.display = 'block';
        return;
      }

      data.forEach(item => {
        const div = document.createElement('div');
        div.className = 'result-item';
        div.textContent = item.display_name;

        div.onclick = () => {
          const destLatLng = L.latLng(item.lat, item.lon);
          const name = item.display_name;

          updateInfoPanel(destLatLng, name);
          drawRoute(destLatLng);
          map.flyTo(destLatLng, 15);

          searchResults.style.display = 'none';
          searchBox.value = '';
        };

        searchResults.appendChild(div);
      });

      searchResults.style.display = 'block';
    } catch (error) {
      showLoading(false);
      console.error('Search error:', error);
      // Search error alert - Th√¥ng b√°o l·ªói t√¨m ki·∫øm
      alert('Search error. Please try again.');
    }
  }

  // Close search results when clicking outside
  document.addEventListener('click', (e) => {
    if (!document.getElementById('searchBar').contains(e.target)) {
      searchResults.style.display = 'none';
    }
  });

  // TAP TO PICK LOCATION
  map.on('click', async (e) => {
    showLoading(true);
    const name = await getLocationName(e.latlng);
    updateInfoPanel(e.latlng, name);
    drawRoute(e.latlng);
    showLoading(false);
  });

  // Confirm button
  document.getElementById('confirmButton').onclick = () => {
    if (selectedLocation) {
      notifyFlutter(
        { lat: selectedLocation.lat, lng: selectedLocation.lon },
        selectedLocation.name,
        currentDistance
      );
    }
  };

  // Toggle Directions
  document.getElementById('toggleDirections').onclick = () => {
    const container = document.querySelector('.leaflet-routing-container');
    if (container) {
      if (container.style.display === 'none' || container.style.display === '') {
        container.style.display = 'block';
      } else {
        container.style.display = 'none';
      }
    }
  };

  // Prevent body scroll on mobile
  document.body.addEventListener('touchmove', function(e) {
    e.preventDefault();
  }, { passive: false });

  console.log('‚úÖ Map initialized');
</script>

</body>
</html>
er a